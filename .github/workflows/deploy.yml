name: Deploy to HostGator with Quality Checks

# Executa o deploy quando hÃ¡ push na branch main
on:
  push:
    branches: [ main, master ]

  # Permite execuÃ§Ã£o manual do workflow
  workflow_dispatch:

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    name: Quality Checks

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --only=dev || npm install

    - name: Basic validation checks
      run: |
        echo "ğŸ” Executando verificaÃ§Ãµes bÃ¡sicas..."

        # Verificar se arquivos essenciais existem
        echo "ğŸ“ Verificando arquivos essenciais..."
        [ -f "index.html" ] && echo "âœ… index.html encontrado" || echo "âŒ index.html nÃ£o encontrado"
        [ -f "admin.html" ] && echo "âœ… admin.html encontrado" || echo "âŒ admin.html nÃ£o encontrado"
        [ -f "assets/css/style.css" ] && echo "âœ… CSS principal encontrado" || echo "âŒ CSS principal nÃ£o encontrado"
        [ -f "assets/js/script.js" ] && echo "âœ… JS principal encontrado" || echo "âŒ JS principal nÃ£o encontrado"
        [ -f "manifest.json" ] && echo "âœ… Manifest PWA encontrado" || echo "âŒ Manifest PWA nÃ£o encontrado"
        [ -f "sw.js" ] && echo "âœ… Service Worker encontrado" || echo "âŒ Service Worker nÃ£o encontrado"

        # Verificar estrutura HTML bÃ¡sica
        echo "ğŸ“„ Verificando estrutura HTML..."
        grep -q "<!DOCTYPE html>" index.html && echo "âœ… DOCTYPE correto" || echo "âŒ DOCTYPE incorreto"
        grep -q 'lang="pt-BR"' index.html && echo "âœ… Idioma definido" || echo "âŒ Idioma nÃ£o definido"
        grep -q 'name="viewport"' index.html && echo "âœ… Viewport definido" || echo "âŒ Viewport nÃ£o definido"
        grep -q 'name="description"' index.html && echo "âœ… Meta description encontrada" || echo "âŒ Meta description nÃ£o encontrada"

        # Verificar links importantes
        echo "ğŸ”— Verificando links..."
        grep -q "wa.me/554284099552" index.html && echo "âœ… WhatsApp link correto" || echo "âŒ WhatsApp link incorreto"

        # Verificar PWA
        echo "ğŸ“± Verificando PWA..."
        grep -q 'rel="manifest"' index.html && echo "âœ… Manifest linkado" || echo "âŒ Manifest nÃ£o linkado"

    - name: Run linting (optional)
      run: |
        echo "ğŸ” Executando linting..."
        npm run lint:html || echo "âš ï¸ HTML linting completed with warnings"
        npm run lint:css || echo "âš ï¸ CSS linting completed with warnings"
        npm run lint:js || echo "âš ï¸ JS linting completed with warnings"

    - name: Check file sizes
      run: |
        echo "ğŸ“ Verificando tamanhos de arquivo..."
        find . -name "*.js" -exec wc -c {} + | awk '$1 > 100000 {print "âš ï¸  Large JS file: " $2 " (" $1 " bytes)"}'
        find . -name "*.css" -exec wc -c {} + | awk '$1 > 50000 {print "âš ï¸  Large CSS file: " $2 " (" $1 " bytes)"}'
        find . -name "*.jpg" -o -name "*.png" -o -name "*.gif" | xargs -I {} sh -c 'size=$(wc -c < "{}"); if [ $size -gt 500000 ]; then echo "âš ï¸  Large image: {} ($size bytes)"; fi'

    - name: Security scan
      run: |
        echo "ğŸ”’ Verificando seguranÃ§a..."
        # Verificar se hÃ¡ credenciais expostas
        if grep -r "password\|secret\|key\|token" --include="*.js" --include="*.html" --include="*.css" .; then
          echo "âš ï¸  PossÃ­veis credenciais encontradas no cÃ³digo"
        fi

        # Verificar headers de seguranÃ§a no .htaccess
        if [ -f ".htaccess" ]; then
          if grep -q "X-Frame-Options\|Content-Security-Policy\|X-Content-Type-Options" .htaccess; then
            echo "âœ… Headers de seguranÃ§a encontrados"
          else
            echo "âš ï¸  Headers de seguranÃ§a nÃ£o encontrados"
          fi
        fi

    - name: Performance check
      run: |
        echo "ğŸš€ Verificando performance..."
        # Contar recursos externos
        external_resources=$(grep -r "https://" --include="*.html" --include="*.css" --include="*.js" . | wc -l)
        echo "ğŸ“Š Recursos externos encontrados: $external_resources"

        if [ $external_resources -gt 10 ]; then
          echo "âš ï¸  Muitos recursos externos podem afetar a performance"
        fi
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Production
    needs: quality-checks
    if: success()

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Prepare deployment
      run: |
        echo "ğŸš€ Preparando deploy..."

        # Criar arquivo de informaÃ§Ãµes de build
        cat > build-info.json << EOF
        {
          "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit_hash": "${{ github.sha }}",
          "commit_message": "${{ github.event.head_commit.message }}",
          "branch": "${{ github.ref_name }}",
          "workflow_run": "${{ github.run_number }}"
        }
        EOF

        # Minificar CSS (bÃ¡sico)
        if command -v csso &> /dev/null; then
          echo "ğŸ¨ Minificando CSS..."
          for file in assets/css/*.css; do
            if [[ -f "$file" && ! "$file" =~ \.min\. ]]; then
              csso "$file" --output "${file%.css}.min.css"
            fi
          done
        fi

        # Otimizar HTML (remover comentÃ¡rios e espaÃ§os extras)
        echo "ğŸ“„ Otimizando HTML..."
        sed -i 's/<!--.*-->//g' *.html
        sed -i '/^[[:space:]]*$/d' *.html

    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftps
        port: 21

        # Pasta local (raiz do repositÃ³rio)
        local-dir: ./

        # Pasta remota no servidor (raiz)
        server-dir: /

        # Arquivos a serem excluÃ­dos do upload
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env*
          **/README.md
          **/.github/**
          **/package*.json
          **/yarn.lock
          **/*.md
          **/tests/**
          **/.vscode/**
          **/.idea/**
          **/logs/**

        # NÃ£o limpar arquivos remotos
        dangerous-clean-slate: false

        # Verificar modificaÃ§Ãµes antes do upload
        dry-run: false

        # Log detalhado
        log-level: verbose

    - name: Post-deployment verification
      run: |
        echo "ğŸ” Verificando deploy..."

        # Aguardar mais tempo para o deploy se propagar
        echo "â³ Aguardando propagaÃ§Ã£o do deploy (60 segundos)..."
        sleep 60

        # FunÃ§Ã£o para verificar URL com retry
        check_url() {
          local url=$1
          local name=$2
          local max_attempts=5
          local attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ Tentativa $attempt/$max_attempts para $name..."

            if curl -f -s -L --max-time 10 "$url" > /dev/null 2>&1; then
              echo "âœ… $name estÃ¡ acessÃ­vel"
              return 0
            fi

            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Aguardando 15 segundos antes da prÃ³xima tentativa..."
              sleep 15
            fi

            attempt=$((attempt + 1))
          done

          echo "âš ï¸  $name nÃ£o estÃ¡ acessÃ­vel apÃ³s $max_attempts tentativas"
          return 1
        }

        # Verificar se o site estÃ¡ acessÃ­vel (tentar HTTPS primeiro, depois HTTP)
        if check_url "https://forgiariniparfum.dehor.dev/" "Site principal (HTTPS)"; then
          site_accessible=true
        elif check_url "http://forgiariniparfum.dehor.dev/" "Site principal (HTTP)"; then
          site_accessible=true
          echo "âš ï¸  Site acessÃ­vel via HTTP, mas HTTPS pode ter problemas"
        else
          site_accessible=false
        fi

        # Verificar recursos apenas se o site estiver acessÃ­vel
        if [ "$site_accessible" = true ]; then
          check_url "https://forgiariniparfum.dehor.dev/assets/css/style.css" "CSS principal" || true
          check_url "https://forgiariniparfum.dehor.dev/assets/js/script.js" "JavaScript principal" || true
          check_url "https://forgiariniparfum.dehor.dev/manifest.json" "PWA Manifest" || true
        fi

        # Verificar se pelo menos o domÃ­nio responde
        echo "ğŸŒ Verificando conectividade do domÃ­nio..."
        if ping -c 3 forgiariniparfum.dehor.dev > /dev/null 2>&1; then
          echo "âœ… DomÃ­nio estÃ¡ respondendo"
        else
          echo "âš ï¸  DomÃ­nio nÃ£o estÃ¡ respondendo ao ping"
        fi

        # NÃ£o falhar o deploy se o site nÃ£o estiver imediatamente acessÃ­vel
        # Isso pode acontecer devido a cache do CDN ou propagaÃ§Ã£o DNS
        if [ "$site_accessible" = false ]; then
          echo "âš ï¸  Site pode nÃ£o estar imediatamente acessÃ­vel devido a:"
          echo "   - Cache do CDN/Proxy"
          echo "   - PropagaÃ§Ã£o DNS"
          echo "   - ConfiguraÃ§Ãµes do servidor"
          echo "   - Aguarde alguns minutos e tente novamente"
          echo "ğŸ¯ Deploy dos arquivos foi concluÃ­do com sucesso!"
        fi

    - name: Notify deployment success
      run: |
        echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
        echo "ğŸŒ Site: https://forgiariniparfum.dehor.dev/"
        echo "ğŸ“Š Commit: ${{ github.sha }}"
        echo "ğŸ•’ HorÃ¡rio: $(date)"
