// Test Runner para Forgiarini Parfum
// Sistema de testes automatizados para valida√ß√£o do frontend

class TestRunner {
    constructor() {
        this.tests = [];
        this.results = {
            passed: 0,
            failed: 0,
            total: 0,
            details: []
        };
    }

    // Adicionar teste
    addTest(name, testFunction) {
        this.tests.push({ name, testFunction });
    }

    // Executar todos os testes
    async runAllTests() {
        console.log('üöÄ Iniciando testes automatizados...\n');
        
        for (const test of this.tests) {
            await this.runTest(test);
        }
        
        this.printResults();
        return this.results;
    }

    // Executar teste individual
    async runTest(test) {
        try {
            const startTime = performance.now();
            await test.testFunction();
            const endTime = performance.now();
            const duration = Math.round(endTime - startTime);
            
            this.results.passed++;
            this.results.details.push({
                name: test.name,
                status: 'PASSED',
                duration: `${duration}ms`,
                error: null
            });
            
            console.log(`‚úÖ ${test.name} (${duration}ms)`);
        } catch (error) {
            this.results.failed++;
            this.results.details.push({
                name: test.name,
                status: 'FAILED',
                duration: null,
                error: error.message
            });
            
            console.log(`‚ùå ${test.name}`);
            console.log(`   Error: ${error.message}`);
        }
        
        this.results.total++;
    }

    // Imprimir resultados
    printResults() {
        console.log('\nüìä Resultados dos Testes:');
        console.log('========================');
        console.log(`Total: ${this.results.total}`);
        console.log(`‚úÖ Passou: ${this.results.passed}`);
        console.log(`‚ùå Falhou: ${this.results.failed}`);
        console.log(`üìà Taxa de Sucesso: ${Math.round((this.results.passed / this.results.total) * 100)}%`);
        
        if (this.results.failed > 0) {
            console.log('\nüîç Testes que falharam:');
            this.results.details
                .filter(test => test.status === 'FAILED')
                .forEach(test => {
                    console.log(`   - ${test.name}: ${test.error}`);
                });
        }
    }

    // Assertion helpers
    static assert(condition, message) {
        if (!condition) {
            throw new Error(message || 'Assertion failed');
        }
    }

    static assertEqual(actual, expected, message) {
        if (actual !== expected) {
            throw new Error(message || `Expected ${expected}, but got ${actual}`);
        }
    }

    static assertNotNull(value, message) {
        if (value === null || value === undefined) {
            throw new Error(message || 'Value should not be null or undefined');
        }
    }

    static assertExists(selector, message) {
        const element = document.querySelector(selector);
        if (!element) {
            throw new Error(message || `Element with selector "${selector}" not found`);
        }
        return element;
    }

    static assertVisible(selector, message) {
        const element = this.assertExists(selector);
        const styles = window.getComputedStyle(element);
        if (styles.display === 'none' || styles.visibility === 'hidden' || styles.opacity === '0') {
            throw new Error(message || `Element "${selector}" is not visible`);
        }
    }

    static assertHasClass(selector, className, message) {
        const element = this.assertExists(selector);
        if (!element.classList.contains(className)) {
            throw new Error(message || `Element "${selector}" does not have class "${className}"`);
        }
    }

    static async waitFor(condition, timeout = 5000, message) {
        const startTime = Date.now();
        while (Date.now() - startTime < timeout) {
            if (await condition()) {
                return;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        throw new Error(message || `Condition not met within ${timeout}ms`);
    }
}

// Testes espec√≠ficos para Forgiarini Parfum
const runner = new TestRunner();

// Teste 1: Verificar se elementos essenciais existem
runner.addTest('Elementos essenciais existem', () => {
    TestRunner.assertExists('header', 'Header n√£o encontrado');
    TestRunner.assertExists('.hero', 'Se√ß√£o hero n√£o encontrada');
    TestRunner.assertExists('#catalog-btn', 'Bot√£o de cat√°logo n√£o encontrado');
    TestRunner.assertExists('footer', 'Footer n√£o encontrado');
    TestRunner.assertExists('.main-nav', 'Navega√ß√£o principal n√£o encontrada');
});

// Teste 2: Verificar se o v√≠deo hero est√° presente
runner.addTest('V√≠deo hero est√° presente', () => {
    TestRunner.assertExists('#hero-video', 'V√≠deo hero n√£o encontrado');
    const video = document.getElementById('hero-video');
    TestRunner.assert(video.tagName === 'VIDEO', 'Elemento n√£o √© um v√≠deo');
});

// Teste 3: Verificar se as se√ß√µes principais existem
runner.addTest('Se√ß√µes principais existem', () => {
    TestRunner.assertExists('#about', 'Se√ß√£o sobre n√£o encontrada');
    TestRunner.assertExists('#signature', 'Se√ß√£o perfume autoral n√£o encontrada');
    TestRunner.assertExists('#prices', 'Se√ß√£o pre√ßos n√£o encontrada');
});

// Teste 4: Verificar se os links do WhatsApp funcionam
runner.addTest('Links do WhatsApp est√£o corretos', () => {
    const whatsappLinks = document.querySelectorAll('a[href*="wa.me"]');
    TestRunner.assert(whatsappLinks.length > 0, 'Nenhum link do WhatsApp encontrado');
    
    whatsappLinks.forEach((link, index) => {
        TestRunner.assert(
            link.href.includes('554284099552'),
            `Link do WhatsApp ${index + 1} n√£o cont√©m o n√∫mero correto`
        );
    });
});

// Teste 5: Verificar se as imagens t√™m alt text
runner.addTest('Imagens t√™m alt text', () => {
    const images = document.querySelectorAll('img');
    images.forEach((img, index) => {
        TestRunner.assert(
            img.alt && img.alt.trim() !== '',
            `Imagem ${index + 1} n√£o tem alt text`
        );
    });
});

// Teste 6: Verificar se os bot√µes s√£o acess√≠veis
runner.addTest('Bot√µes s√£o acess√≠veis', () => {
    const buttons = document.querySelectorAll('button, .btn');
    buttons.forEach((button, index) => {
        const hasText = button.textContent.trim() !== '';
        const hasAriaLabel = button.hasAttribute('aria-label');
        const hasTitle = button.hasAttribute('title');
        
        TestRunner.assert(
            hasText || hasAriaLabel || hasTitle,
            `Bot√£o ${index + 1} n√£o tem texto ou aria-label`
        );
    });
});

// Teste 7: Verificar se o CSS est√° carregado
runner.addTest('CSS est√° carregado', () => {
    const body = document.body;
    const styles = window.getComputedStyle(body);
    TestRunner.assert(
        styles.fontFamily.includes('Montserrat') || styles.fontFamily !== 'Times',
        'CSS principal n√£o parece estar carregado'
    );
});

// Teste 8: Verificar se JavaScript est√° funcionando
runner.addTest('JavaScript est√° funcionando', () => {
    TestRunner.assert(typeof window.analyticsManager !== 'undefined', 'Analytics manager n√£o inicializado');
    TestRunner.assert(document.readyState === 'complete', 'Documento n√£o completamente carregado');
});

// Teste 9: Verificar responsividade b√°sica
runner.addTest('Responsividade b√°sica', () => {
    const container = document.querySelector('.container');
    TestRunner.assertExists('.container', 'Container n√£o encontrado');
    
    const styles = window.getComputedStyle(container);
    TestRunner.assert(
        styles.maxWidth !== 'none',
        'Container n√£o tem max-width definido'
    );
});

// Teste 10: Verificar se o manifest PWA existe
runner.addTest('Manifest PWA existe', () => {
    const manifestLink = document.querySelector('link[rel="manifest"]');
    TestRunner.assertNotNull(manifestLink, 'Link do manifest PWA n√£o encontrado');
    TestRunner.assert(
        manifestLink.href.includes('manifest.json'),
        'Manifest PWA n√£o aponta para manifest.json'
    );
});

// Teste 11: Verificar meta tags essenciais
runner.addTest('Meta tags essenciais existem', () => {
    TestRunner.assertExists('meta[name="description"]', 'Meta description n√£o encontrada');
    TestRunner.assertExists('meta[name="viewport"]', 'Meta viewport n√£o encontrada');
    TestRunner.assertExists('meta[property="og:title"]', 'Meta og:title n√£o encontrada');
});

// Teste 12: Verificar se o bot√£o de cat√°logo funciona
runner.addTest('Bot√£o de cat√°logo √© clic√°vel', async () => {
    const catalogBtn = TestRunner.assertExists('#catalog-btn', 'Bot√£o de cat√°logo n√£o encontrado');
    
    // Simular clique
    let clicked = false;
    catalogBtn.addEventListener('click', () => {
        clicked = true;
    }, { once: true });
    
    catalogBtn.click();
    
    await TestRunner.waitFor(() => clicked, 1000, 'Bot√£o de cat√°logo n√£o respondeu ao clique');
});

// Teste 13: Verificar performance b√°sica
runner.addTest('Performance b√°sica', () => {
    const navigation = performance.getEntriesByType('navigation')[0];
    if (navigation) {
        const loadTime = navigation.loadEventEnd - navigation.navigationStart;
        TestRunner.assert(
            loadTime < 5000,
            `Tempo de carregamento muito alto: ${loadTime}ms`
        );
    }
});

// Teste 14: Verificar se n√£o h√° erros de console
runner.addTest('Sem erros cr√≠ticos de console', () => {
    // Este teste seria mais efetivo se executado em um ambiente de teste real
    // Por enquanto, verificamos se elementos essenciais est√£o funcionando
    TestRunner.assert(
        !document.body.classList.contains('error'),
        'P√°gina indica estado de erro'
    );
});

// Teste 15: Verificar se o service worker est√° registrado
runner.addTest('Service Worker est√° registrado', async () => {
    if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.getRegistration();
        TestRunner.assertNotNull(registration, 'Service Worker n√£o est√° registrado');
    } else {
        console.log('‚ö†Ô∏è  Service Worker n√£o suportado neste navegador');
    }
});

// Fun√ß√£o para executar testes automaticamente
async function runAutomatedTests() {
    // Aguardar carregamento completo
    if (document.readyState !== 'complete') {
        await new Promise(resolve => {
            window.addEventListener('load', resolve);
        });
    }
    
    // Aguardar um pouco mais para garantir que scripts foram executados
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const results = await runner.runAllTests();
    
    // Enviar resultados para analytics se dispon√≠vel
    if (window.analyticsManager) {
        window.analyticsManager.trackEvent('automated_tests_completed', {
            total: results.total,
            passed: results.passed,
            failed: results.failed,
            success_rate: Math.round((results.passed / results.total) * 100)
        });
    }
    
    return results;
}

// Executar testes se estivermos em modo de desenvolvimento
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.search.includes('test=true')) {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(runAutomatedTests, 2000);
    });
}

// Exportar para uso manual
window.runTests = runAutomatedTests;
window.TestRunner = TestRunner;
